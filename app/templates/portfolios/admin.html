{% extends "base.html" %}

{% block title %}Portfolio{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center mb-4">Portfolio {{ portfolio.Name }}</h1>

    <div class="d-flex justify-content-end mb-3">
        <a href="#" class="btn btn-primary open-modal" data-url="/portfolios/{{ portfolio.Id }}/candidates">
            <i class="fas fa-plus-circle"></i>
        </a>
    </div>
    
    <div id="portfolioMetrics">
        
    </div>

    <div class="table-responsive">
        <table id="botsTable" class="table table-custom">
            <thead>
                <tr>
                    <th>Bot</th>
                    <th>StabilityRatio</th>
                    <th>Return</th>
                    <th>Drawdown</th>
                    <th>RreturnDd</th>
                    <th>CustomMetric</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for performance in portfolio.BotPerformances %}
                    <tr>
                        <td>
                            <a href='/backtest/bot/{{ performance.BotId }}?date_from={{ performance.DateFrom }}&date_to={{ performance.DateTo }}'>
                                {{ performance.Bot.Name }}
                            </a>
                        </td>
                        <td>{{ performance.StabilityRatio }}</td>
                        <td>{{ performance.Return }}</td>
                        <td>{{ performance.Drawdown }}</td>
                        <td>{{ performance.RreturnDd }}</td>
                        <td>{{ performance.CustomMetric }}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-add toggle-add" data-performance-id="{{ performance.Id }}">
                                <i class="fas fa-minus-circle"></i>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="modal-container"></div>

<script>
    async function loadPortfolioMetrics() {
        const portfolioId = "{{ portfolio.Id }}";
        const url = `/portfolios/admin/${portfolioId}/metrics`;
        const metricsDiv = document.getElementById("portfolioMetrics");

        try {
            // Hacer que el contenido desaparezca con una transici√≥n suave
            metricsDiv.style.transition = "opacity 0.3s ease-out";
            metricsDiv.style.opacity = "0";

            let response = await fetch(url);
            if (!response.ok) throw new Error("Error al obtener las m√©tricas del portafolio.");

            let html = await response.text();

            // Esperar un peque√±o tiempo antes de insertar el nuevo contenido
            setTimeout(() => {
                metricsDiv.innerHTML = html;
                metricsDiv.style.opacity = "1"; // Volver a mostrar el contenido suavemente

                // üìå 1. Asegurar que el gr√°fico de Plotly se renderice correctamente
                let scriptTag = document.getElementById("portfolioMetrics").querySelector("#equity-plot-data");
                if (scriptTag) {
                    let plotData = JSON.parse(scriptTag.textContent);
                    console.log("üìä Datos del gr√°fico Plotly:", plotData); // Depuraci√≥n

                    if (plotData.data && plotData.data.length > 0) {
                        Plotly.newPlot('equity-plot', plotData.data, plotData.layout);
                    } else {
                        console.warn("‚ö†Ô∏è El gr√°fico de Plotly no tiene datos v√°lidos.");
                    }
                }

            }, 300); // Tiempo suficiente para completar el fade-out antes de mostrar el nuevo contenido

        } catch (error) {
            console.error("‚ùå Error cargando las m√©tricas del portafolio:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const modalContainer = document.getElementById("modal-container");
        const portfolioId = "{{ portfolio.Id }}"; // Se obtiene desde Jinja2

        document.querySelectorAll(".open-modal").forEach(button => {
            button.addEventListener("click", function () {
                const url = this.dataset.url;

                fetch(url)
                    .then(response => response.ok ? response.text() : Promise.reject("No se pudo cargar el modal."))
                    .then(html => {
                        modalContainer.innerHTML = html;

                        const modalElement = document.getElementById("botsModal");
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();

                        $('#favoritesTable').DataTable({
                            paging: true,
                            searching: true,
                            ordering: true,
                            info: true,
                            order: [[5, 'desc']],
                            pageLength: 5,
                            lengthMenu: [[5, 10, 20], [5, 10, 20, 'Todos']]
                        });
                    })
                    .catch(error => console.error("Error:", error));
            });
        });

        modalContainer.addEventListener("click", function (event) {
            let modalElement = document.getElementById("botsModal");

            if (modalElement) {
                modalElement.addEventListener("hidden.bs.modal", function () {
                    location.reload(); // Recargar la p√°gina cuando el modal se cierra
                });
            }
        });

        // Delegaci√≥n de eventos para botones de agregar y borrar backtests
        document.addEventListener("click", async function (event) {
            let button = event.target.closest(".toggle-add"); 
            if (!button) return;


            const performanceId = button.getAttribute("data-performance-id");
            if (!performanceId) {
                console.warn("No se encontr√≥ performanceId en el bot√≥n.");
                return;
            }

            let icon = button.querySelector("i");
            if (!icon) {
                console.error("No se encontr√≥ el icono dentro del bot√≥n.");
                return;
            }

            // **Ahora se eval√∫a isAdding en funci√≥n del icono actual**
            let isAdding = icon.classList.contains("fa-plus-circle");
            let url = `/portfolios/admin/${portfolioId}/${isAdding ? "add" : "delete"}/${performanceId}`;

            try {
                console.log(url)
                let response = await fetch(url, { method: "POST" });

                if (response.ok) {
                    console.log(response)
                    // Cambiar icono
                    if (isAdding) {
                        icon.classList.replace("fa-plus-circle", "fa-minus-circle");
                        button.classList.replace("btn-primary", "btn-danger");
                    } else {
                        icon.classList.replace("fa-minus-circle", "fa-plus-circle");
                        button.classList.replace("btn-danger", "btn-primary");

                    }

                    loadPortfolioMetrics();

                } else {
                    console.error("Error en la solicitud:", response.statusText);
                }
            } catch (error) {
                console.error("Error en la solicitud:", error);
            }
        });
        
        loadPortfolioMetrics();
        
    });
</script>



{% endblock %}

